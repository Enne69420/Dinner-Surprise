version: 2
# AWS Amplify Gen 2 Configuration
frontend:
  phases:
    preBuild:
      commands:
        - 'npm ci'
        # Create environment file for Next.js
        - 'touch .env.local'
        - 'echo "NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL" >> .env.local'
        - 'echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env.local'
        - 'echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY" >> .env.local'
        - 'echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" >> .env.local'
        - 'echo "NEXT_PUBLIC_PRICE_ID_PREMIUM_MONTHLY=$NEXT_PUBLIC_PRICE_ID_PREMIUM_MONTHLY" >> .env.local'
        - 'echo "NEXT_PUBLIC_PRICE_ID_PREMIUM_YEARLY=$NEXT_PUBLIC_PRICE_ID_PREMIUM_YEARLY" >> .env.local'
        - 'echo "NEXT_PUBLIC_AWS_REGION=$AWS_REGION" >> .env.local'
        - 'echo "NEXT_PUBLIC_API_ENDPOINT=$NEXT_PUBLIC_API_ENDPOINT" >> .env.local'
        # Safely show the environment file without revealing secrets
        - 'echo "Environment file created for frontend build"'
    build:
      commands:
        - 'npm run build'
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# Simple backend config that doesn't try to use Amplify CLI
backend:
  phases:
    build:
      commands:
        - 'echo "Using App ID: d2odppyr9yu5gf in region: us-east-1"'
        - 'echo "Environment: main"'
        - 'echo "Skipping backend deployment - using existing resources"'

# Lambda function configuration with all required environment variables
function:
  - name: "dinnerSurpriseFunction"
    runtime: "nodejs18.x"
    handler: "src/index.handler"
    environment:
      variables:
        NODE_ENV: "production"
        # Add direct references to environment variables from Amplify console
        STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
        STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
        DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}