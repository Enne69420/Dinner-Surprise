<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Table Fix Instructions</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #3ECF8E;
            border-bottom: 2px solid #3ECF8E;
            padding-bottom: 10px;
        }
        h2 {
            color: #3D3D3D;
            margin-top: 30px;
        }
        pre {
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        .step {
            background-color: #f9f9f9;
            border-left: 4px solid #3ECF8E;
            margin: 20px 0;
            padding: 16px;
            border-radius: 0 6px 6px 0;
        }
        .warning {
            background-color: #fff8e6;
            border-left: 4px solid #f0ad4e;
            padding: 16px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }
    </style>
</head>
<body>
    <h1>Fixing User Subscriptions Table in Supabase</h1>
    
    <p>This guide will help you fix the issues with the <code>user_subscriptions</code> table in your Supabase database.</p>
    
    <div class="warning">
        <strong>Important:</strong> Back up your database before running any of these scripts. These scripts are designed to be idempotent (safe to run multiple times), but backups are always a good practice.
    </div>
    
    <h2>Problem Description</h2>
    <p>The application uses two tables to track user subscription information:</p>
    <ul>
        <li><code>profiles</code> - Contains basic user information and tier status</li>
        <li><code>user_subscriptions</code> - Contains detailed subscription information for payments and feature access</li>
    </ul>
    <p>Currently, the <code>user_subscriptions</code> table is empty, which causes errors when saving recipes or accessing premium features.</p>
    
    <h2>Solution: Run The Following SQL Scripts</h2>
    
    <div class="step">
        <h3>Step 1: Create & Populate User Subscriptions Table</h3>
        <p>Run this script to create the table if it doesn't exist and populate it with data from the profiles table:</p>
        <pre><code>-- SQL script to migrate data from profiles to user_subscriptions table

-- First, create the user_subscriptions table if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'user_subscriptions'
  ) THEN
    CREATE TABLE public.user_subscriptions (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
      subscription_id TEXT,
      stripe_subscription_id TEXT,
      stripe_customer_id TEXT,
      plan_type TEXT NOT NULL DEFAULT 'free' CHECK (plan_type IN ('free', 'premium', 'family')),
      price_id TEXT,
      status TEXT NOT NULL DEFAULT 'active',
      current_period_start TIMESTAMPTZ,
      current_period_end TIMESTAMPTZ,
      created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Create indexes for faster lookups
    CREATE INDEX idx_user_subscriptions_user_id ON public.user_subscriptions(user_id);
    CREATE INDEX idx_user_subscriptions_subscription_id ON public.user_subscriptions(subscription_id);
    CREATE INDEX idx_user_subscriptions_stripe_customer_id ON public.user_subscriptions(stripe_customer_id);

    -- Set up RLS (Row Level Security)
    ALTER TABLE public.user_subscriptions ENABLE ROW LEVEL SECURITY;

    -- Create policies for RLS
    -- 1. Users can read their own subscription data
    CREATE POLICY "Users can read their own subscription data"
      ON public.user_subscriptions
      FOR SELECT
      USING (auth.uid() = user_id);

    -- 2. Service role can manage all subscription data
    CREATE POLICY "Service role can manage all subscription data"
      ON public.user_subscriptions
      USING (true)
      WITH CHECK (true);
  END IF;
END
$$;

-- Then insert data from profiles into user_subscriptions
-- Only insert for profiles that don't already have a subscription
INSERT INTO public.user_subscriptions (
  user_id,
  plan_type,
  status,
  current_period_start,
  current_period_end,
  created_at,
  updated_at
)
SELECT 
  id AS user_id,
  tier AS plan_type,
  'active' AS status,
  created_at AS current_period_start,
  (created_at + interval '1 month') AS current_period_end,
  created_at,
  updated_at
FROM 
  public.profiles p
WHERE 
  NOT EXISTS (
    SELECT 1 FROM public.user_subscriptions us WHERE us.user_id = p.id
  );

-- Count how many records were inserted
DO $$
DECLARE
  inserted_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO inserted_count FROM public.user_subscriptions;
  RAISE NOTICE 'Total user_subscriptions after migration: %', inserted_count;
END
$$;</code></pre>
    </div>
    
    <div class="step">
        <h3>Step 2: Create Trigger for New Profiles</h3>
        <p>Run this script to create a trigger that will automatically add users to the user_subscriptions table when they're created:</p>
        <pre><code>-- Create a function that will be triggered when a new profile is created
CREATE OR REPLACE FUNCTION create_user_subscription()
RETURNS TRIGGER AS $$
BEGIN
  -- Insert a new record into user_subscriptions
  INSERT INTO public.user_subscriptions (
    user_id,
    plan_type,
    status,
    current_period_start,
    current_period_end,
    created_at,
    updated_at
  )
  VALUES (
    NEW.id,
    NEW.tier,
    'active',
    NEW.created_at,
    (NEW.created_at + interval '1 month'),
    NEW.created_at,
    NEW.updated_at
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create the trigger to run after a new profile is inserted
DROP TRIGGER IF EXISTS create_subscription_for_new_profile ON public.profiles;
CREATE TRIGGER create_subscription_for_new_profile
AFTER INSERT ON public.profiles
FOR EACH ROW
EXECUTE FUNCTION create_user_subscription();</code></pre>
    </div>
    
    <div class="step">
        <h3>Step 3 (Optional): Create Function for Programmatic User Creation</h3>
        <p>Run this script if you need to programmatically create users with proper authentication:</p>
        <pre><code>-- Function to create a user programmatically with proper auth setup
CREATE OR REPLACE FUNCTION public.create_user(
    email text,
    password text,
    user_role text DEFAULT 'authenticated',
    user_metadata jsonb DEFAULT '{}'::jsonb
) RETURNS uuid AS $$
DECLARE
    user_id uuid;
    encrypted_pw text;
    now_time timestamptz := now();
BEGIN
    -- Generate UUID for new user
    user_id := gen_random_uuid();
    
    -- Encrypt password using Supabase Auth's method (bcrypt)
    encrypted_pw := crypt(password, gen_salt('bf'));
    
    -- Insert into auth.users table
    INSERT INTO auth.users (
        instance_id,
        id,
        aud,
        role,
        email,
        encrypted_password,
        email_confirmed_at,
        recovery_sent_at,
        last_sign_in_at,
        raw_app_meta_data,
        raw_user_meta_data,
        created_at,
        updated_at,
        confirmation_token,
        email_change,
        email_change_token_new,
        recovery_token
    ) VALUES (
        '00000000-0000-0000-0000-000000000000',
        user_id,
        'authenticated',
        user_role,
        email,
        encrypted_pw,
        now_time, -- Email auto-confirmed
        NULL,
        NULL,
        '{"provider":"email","providers":["email"]}'::jsonb,
        user_metadata,
        now_time,
        now_time,
        '',
        '',
        '',
        ''
    );
    
    -- Insert into auth.identities table (required for login)
    INSERT INTO auth.identities (
        id,
        provider_id,
        user_id,
        identity_data,
        provider,
        last_sign_in_at,
        created_at,
        updated_at
    ) VALUES (
        gen_random_uuid(),
        user_id,
        user_id,
        jsonb_build_object(
            'sub', user_id::text,
            'email', email,
            'email_verified', 'true',
            'phone_verified', 'false'
        ),
        'email',
        now_time,
        now_time,
        now_time
    );
    
    -- The trigger on auth.users will automatically create profile
    
    RETURN user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;</code></pre>
    </div>
    
    <h2>How to Run These Scripts</h2>
    <ol>
        <li>Log in to your Supabase dashboard</li>
        <li>Go to the SQL Editor tab</li>
        <li>Create a new SQL query</li>
        <li>Copy and paste each script one at a time</li>
        <li>Click "Run" to execute the script</li>
        <li>Check for any errors in the output</li>
    </ol>
    
    <h2>Verification</h2>
    <p>After running the scripts, verify that the data has been properly migrated:</p>
    <pre><code>-- Check that user_subscriptions table has data
SELECT COUNT(*) FROM public.user_subscriptions;

-- Verify that the data matches profiles
SELECT 
  p.id, 
  p.tier, 
  us.plan_type,
  us.status
FROM 
  public.profiles p
LEFT JOIN 
  public.user_subscriptions us ON p.id = us.user_id
LIMIT 100;</code></pre>
    
    <div class="warning">
        <p>If you encounter any errors or issues, please contact the development team for assistance.</p>
    </div>
</body>
</html> 